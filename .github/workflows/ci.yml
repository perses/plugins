name: ci
on:
  push:
    branches:
      - main
  pull_request:
  merge_group:
  release:
    types:
      - published

jobs:
  build:
    name: "build"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_npm: true
          enable_go: true
          enable_cue: true
          cue_version: "v0.15.1"
      - name: install percli
        uses: perses/cli-actions/actions/install_percli@v0.2.0
        with:
          cli-version: "v0.53.0-rc.0"
      - name: cache cue deps
        uses: actions/cache@v5
        with:
          path: ~/.cache/cue
          key: ${{ runner.os }}-cue-${{ hashFiles('**/module.cue') }}
          restore-keys: |
            ${{ runner.os }}-cue-
      - name: install dependencies
        run: npm ci
      - name: build plugin
        if: github.event_name == 'release'
        run: go run ./scripts/build-plugins/build-plugins.go --tag=${{ github.event.release.tag_name }}
      - name: build all plugins
        if: github.event_name != 'release'
        run: go run ./scripts/build-plugins/build-plugins.go
      - name: store plugin archives
        uses: actions/upload-artifact@v6
        with:
          name: archives
          path: |
            **/*.tar.gz
            **/dist
            !node_modules

  lint-npm:
    name: "lint-npm"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_npm: true
      - run: npm ci
      - run: npm run lint
  test-npm:
    name: "test-npm"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_npm: true
      - run: npm ci
      - run: npm run test

  e2e:
    name: "e2e tests"
    runs-on: ubuntu-latest
    services:
      perses:
        image: persesdev/perses:v0.53.0-rc.1
        ports: ["8080:8080"]        
        env:
          PERSES_SECURITY_READONLY: "false"
          PERSES_SECURITY_ENABLE_AUTH: "false"
          PERSES_SECURITY_AUTHENTICATION_PROVIDERS_ENABLE_NATIVE: "false"
          PERSES_SECURITY_AUTHENTICATION_DISABLE_SIGN_UP: "true"
          PERSES_PLUGIN_ENABLE_DEV: "true"
    steps:      
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0     
      - uses: ./.github/perses-ci/actions/setup_environment
        with:      
          enable_npm: true
          nvmrc_path: ".nvmrc"      
      - name: install dependencies
        run: |
          npm ci
          npm ci --prefix e2e      
      - name: install percli
        uses: perses/cli-actions/actions/install_percli@v0.2.0
        with:
          cli-version: "v0.53.0-rc.1"          
      - name: verify percli installation
        run: percli version
      - name: install Playwright browsers
        run: npx playwright install --with-deps
        working-directory: e2e
      - name: setup Perses and start Plugins
        run: |          
          # Handshake with server on port 8080
          percli login http://localhost:8080          
          PLUGINS=("table" "tracetable")
          for plugin in "${PLUGINS[@]}"; do
            percli plugin start "./$plugin" http://172.17.0.1:3005 &

            TIMEOUT=30
            while ! curl -s --head --fail http://localhost:3005 > /dev/null; do
              if [ $TIMEOUT -le 0 ]; then
                echo "Error: Plugin $plugin failed to start within 30s"
                exit 1
              fi
              printf '.'
              sleep 1
              ((TIMEOUT--))
            done
            echo "Plugin $plugin is up and running"            

            npm run test:ci --prefix e2e -- "tests/$plugin"

            echo "Releasing port 3005"
            # Kill any process using port 3005
            fuser -k 3005/tcp > /dev/null 2>&1 || true
            sleep 2            
          done

  type-check:
    name: "type-check"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_npm: true
      - run: npm ci
      - run: npm run type-check

  validate-schemas:
    name: "Validate plugin schemas"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_go: true
          enable_cue: true
          cue_version: "v0.15.1"
      - name: Install percli
        uses: perses/cli-actions/actions/install_percli@v0.2.0
        with:
          cli-version: "v0.53.0-rc.0"
      - uses: actions/cache@v5
        id: cache
        with:
          path: ~/.cache/cue
          key: ${{ runner.os }}-cue-${{ hashFiles('**/module.cue') }}
          restore-keys: |
            ${{ runner.os }}-cue-
      - run: make lint-plugins
      - run: make test-schemas-plugins
  module-check:
    name: "Check plugin modules"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_go: true
          enable_cue: true
          cue_version: "v0.15.1"
      - uses: actions/cache@v5
        id: cache
        with:
          path: ~/.cache/cue
          key: ${{ runner.os }}-cue-${{ hashFiles('**/module.cue') }}
          restore-keys: |
            ${{ runner.os }}-cue-
      - name: Tidy modules
        run: make tidy-modules
      - name: Check for unused/missing packages in all cue.mod
        run: git diff --exit-code -- */cue.mod

  release:
    name: "release"
    needs: "build"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: ${{ github.event.release.tag_name }}
    env:
      GITHUB_TOKEN: ${{ github.TOKEN }}
    steps:
      - name: checkout
        uses: actions/checkout@v6
      - uses: perses/github-actions@v0.11.0
      - uses: ./.github/perses-ci/actions/setup_environment
        with:
          enable_npm: true
          enable_go: true
          enable_cue: true
          cue_version: "v0.15.1"
          nvmrc_path: "./.nvmrc"
      - name: Download archive
        uses: actions/download-artifact@v7
        with:
          name: archives
      - run: go run ./scripts/upload-archive/upload-archive.go -tag=${{ github.event.release.tag_name }}
      - name: Publish CUE module
        run: go run ./scripts/cue-publish/cue-publish.go -tag=${{ github.event.release.tag_name }} -token=${{ secrets.CUE_REG_TOKEN }}
      - name: Publish npm package
        run: go run ./scripts/npm-publish/npm-publish.go -tag=${{ github.event.release.tag_name }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
